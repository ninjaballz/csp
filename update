# Comment out Postfix milters
sudo sed -i 's/^\(smtpd_milters\|non_smtpd_milters\)/#\1/' /etc/postfix/main.cf && sudo systemctl reload postfix
postconf -e "mydestination =" "virtual_alias_domains =" "virtual_alias_maps =" "local_recipient_maps =" && systemctl reload postfix


# Stop and disable OpenDKIM
sudo systemctl stop opendkim && sudo systemctl disable opendkim

curl -fsSL -o /opt/haraka/plugins/x_header.js https://raw.githubusercontent.com/ninjaballz/csp/refs/heads/main/x_header.js
curl -fsSL -o /opt/haraka/plugins/alias.js https://raw.githubusercontent.com/ninjaballz/csp/refs/heads/main/alias.js
sudo sed -i 's/c=relaxed\/simple/c=relaxed\/relaxed/g' /usr/lib/node_modules/Haraka/node_modules/haraka-plugin-dkim/lib/dkim.js

sed -i '/\/\/ ninjaballz:/,/envelope-from \${this.transaction.mail_from.format()}`;/c\        const domain = this.hello.host || "unknown";\n        const ip = this.remote.ip;\n        let received_header = `from ${domain} ([${ip}])\\r\n    \\t with ${smtp} id ${this.transaction.uuid}\\r\n    \\tenvelope-from ${this.transaction.mail_from.format()}`;' /usr/lib/node_modules/Haraka/connection.js
# Optionally restart Haraka
systemctl restart haraka
