# Comment out Postfix milters
sudo sed -i 's/^\(smtpd_milters\|non_smtpd_milters\)/#\1/' /etc/postfix/main.cf && sudo systemctl reload postfix
postconf -e "mydestination =" "virtual_alias_domains =" "virtual_alias_maps =" "local_recipient_maps =" && systemctl reload postfix


# Stop and disable OpenDKIM
sudo systemctl stop opendkim && sudo systemctl disable opendkim

curl -fsSL -o /opt/haraka/plugins/x_header.js https://raw.githubusercontent.com/ninjaballz/csp/refs/heads/main/x_header.js
curl -fsSL -o /opt/haraka/plugins/alias.js https://raw.githubusercontent.com/ninjaballz/csp/refs/heads/main/alias.js
sudo sed -i 's/c=relaxed\/simple/c=relaxed\/relaxed/g' /usr/lib/node_modules/Haraka/node_modules/haraka-plugin-dkim/lib/dkim.js
sudo sed -i "s/^concurrency_max = .*/concurrency_max = 200/; s/^pool_concurrency_max = .*/pool_concurrency_max = 5/; s/^pool_timeout = .*/pool_timeout = 10/; s/^received_header = .*/received_header = JKBANG/" /opt/haraka/config/outbounds.ini && sudo haraka -c /opt/haraka
echo "âœ… Plugins updated successfully."
# Optionally restart Haraka
systemctl restart haraka
